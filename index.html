<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIT Preventive Maintenance Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            background: white;
            color: #1a365d;
            border-bottom-color: #1a365d;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #1a365d;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #1a365d;
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 54, 93, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 161, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #d69e2e 0%, #ecc94b 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
            color: white;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #1a365d;
        }

        .card h3 {
            color: #1a365d;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-container input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .completion-rate {
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            color: white;
            font-size: 1.2em;
        }

        .completion-rate.green {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
        }

        .completion-rate.yellow {
            background: linear-gradient(135deg, #d69e2e 0%, #ecc94b 100%);
        }

        .completion-rate.red {
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
        }

        .completion-rate .rate {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            color: #1a365d;
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #6c757d;
        }

        .close:hover {
            color: #e53e3e;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        .file-upload {
            border: 2px dashed #1a365d;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9fa;
            border-color: #2d5a87;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .schedule-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #1a365d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .schedule-item.overdue {
            border-left-color: #e53e3e;
        }

        .schedule-item.due-soon {
            border-left-color: #d69e2e;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .employee-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .employee-card .name {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .employee-card .count {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AIRBUS AIT</h1>
            <div class="subtitle">Preventive Maintenance Management System</div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('equipment-list')">Equipment List</button>
            <button class="nav-tab" onclick="showTab('pm-entry')">PM Completion Entry</button>
            <button class="nav-tab" onclick="showTab('schedule')">PM Schedule</button>
            <button class="nav-tab" onclick="showTab('search')">Equipment Search</button>
            <button class="nav-tab" onclick="showTab('reports')">Performance Reports</button>
            <button class="nav-tab" onclick="showTab('data-management')">Data Management</button>
            <button class="nav-tab" onclick="showTab('add-equipment')">Add Equipment</button>
        </div>

        <!-- Equipment List Tab -->
        <div id="equipment-list" class="tab-content active">
            <div class="card">
                <h3>Equipment Management</h3>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
                        üîß Administrator: Load Equipment CSV
                    </button>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="loadCSVFile(event)">
                    <button class="btn btn-success" onclick="refreshEquipmentList()">üîÑ Refresh Equipment List</button>
                    <button class="btn btn-warning" onclick="exportEquipmentData()">üì§ Export Equipment Data</button>
                    <button class="btn btn-primary" onclick="syncData()">üîÑ Sync Data</button>
                </div>
                
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>üìã For Employees:</strong> Your equipment data is automatically loaded. Just use the PM Completion Entry tab to log your work.<br>
                    <strong>üë®‚Äçüíº For Administrators:</strong> Use "Load Equipment CSV" to update the equipment database for all users.
                </div>
                
                <div class="search-container">
                    <input type="text" class="form-control" placeholder="Search equipment..." id="equipmentSearchInput" oninput="filterEquipment()">
                    <span class="search-icon">üîç</span>
                </div>

                <div class="table-container">
                    <table class="data-table" id="equipmentTable">
                        <thead>
                            <tr>
                                <th>SAP Material No.</th>
                                <th>BFM Equipment No.</th>
                                <th>Description</th>
                                <th>Site Location</th>
                                <th>Last PM Date</th>
                                <th>Next PM Date</th>
                                <th>PM Frequency</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentTableBody">
                            <!-- Equipment data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PM Completion Entry Tab -->
        <div id="pm-entry" class="tab-content">
            <div class="card">
                <h3>PM Completion Entry</h3>
                <form id="pmCompletionForm" onsubmit="submitPMCompletion(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="technician">Technician:</label>
                            <select class="form-control" id="technician" required>
                                <option value="">Select Technician</option>
                                <option value="Jerone Bosarge">Jerone Bosarge</option>
                                <option value="James Dunnam">James Dunnam</option>
                                <option value="Wayne Dunnam">Wayne Dunnam</option>
                                <option value="Nate Williams">Nate Williams</option>
                                <option value="Mark Michaels">Mark Michaels</option>
                                <option value="Rey Marikit">Rey Marikit</option>
                                <option value="Ronnie Hugh">Ronnie Hugh</option>
                                <option value="Nick Whisenant">Nick Whisenant</option>
                                <option value="Jon Hymel">Jon Hymel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="completionDate">Completion Date:</label>
                            <input type="date" class="form-control" id="completionDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="equipmentSearch">Equipment Search (BFM/SAP/Description):</label>
                        <input type="text" class="form-control" id="equipmentSearch" 
                               placeholder="Start typing to search equipment..." 
                               oninput="searchEquipmentForPM()" autocomplete="off">
                        <div id="equipmentSuggestions" style="position: relative; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; display: none; z-index: 100;"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="hoursWorked">Hours Worked:</label>
                            <input type="number" class="form-control" id="hoursWorked" step="0.5" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="pmType">PM Type:</label>
                            <select class="form-control" id="pmType" required>
                                <option value="">Select PM Type</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-Monthly">Bi-Monthly</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Six Month">Six Month</option>
                                <option value="Annual">Annual</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pmNotes">Notes:</label>
                        <textarea class="form-control" id="pmNotes" rows="4" placeholder="Enter any notes about the PM completion..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">Submit PM Completion</button>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>My PM Completions</h3>
                    <div>
                        <button class="btn btn-primary" onclick="exportMyCompletions()">
                            üì§ Export My Data (Send to Manager)
                        </button>
                        <button class="btn btn-warning" onclick="exportWeeklyReport()">
                            üìä Export Weekly Report
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>üìã For Employees:</strong> Use "Export My Data" to send your PM completions to your manager for consolidated reporting.<br>
                    <strong>üë®‚Äçüíº For Managers:</strong> Collect exported files from all employees and use the "Data Management" tab to import and consolidate.
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="recentCompletionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Technician</th>
                                <th>Equipment</th>
                                <th>Hours</th>
                                <th>PM Type</th>
                            </tr>
                        </thead>
                        <tbody id="recentCompletionsBody">
                            <!-- Recent completions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PM Schedule Tab -->
        <div id="schedule" class="tab-content">
            <div class="card">
                <h3>Weekly PM Schedule Generation</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="weekStart">Week Starting:</label>
                        <input type="date" class="form-control" id="weekStart">
                    </div>
                    <div style="display: flex; align-items: end; gap: 10px;">
                        <button class="btn btn-primary" onclick="generateWeeklySchedule()">Generate Weekly Schedule</button>
                        <button class="btn btn-warning" onclick="generateAllSchedulesForYear()">Generate All Schedules for Year</button>
                        <button class="btn btn-success" onclick="printSchedule()">Print Schedule</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="scheduledPMCount">0</div>
                        <div class="label">PMs Scheduled</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="targetPMCount">110</div>
                        <div class="label">Target PMs/Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="completionPercentage">0%</div>
                        <div class="label">Target Achievement</div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th>BFM Equipment No.</th>
                                <th>Description</th>
                                <th>Location</th>
                                <th>PM Frequency</th>
                                <th>Status</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Schedule data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Equipment Search Tab -->
        <div id="search" class="tab-content">
            <div class="card">
                <h3>Equipment Search</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchCriteria">Search By:</label>
                        <select class="form-control" id="searchCriteria">
                            <option value="all">All Fields</option>
                            <option value="sap">SAP Material No.</option>
                            <option value="bfm">BFM Equipment No.</option>
                            <option value="description">Description</option>
                            <option value="location">Location</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchTerm">Search Term:</label>
                        <input type="text" class="form-control" id="searchTerm" placeholder="Enter search term..." oninput="performSearch()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="searchResultsTable">
                        <thead>
                            <tr>
                                <th>SAP Material No.</th>
                                <th>BFM Equipment No.</th>
                                <th>Description</th>
                                <th>Site Location</th>
                                <th>Last PM Date</th>
                                <th>Next PM Date</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                            <!-- Search results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data-management" class="tab-content">
            <div class="card">
                <h3>üë®‚Äçüíº Manager Data Consolidation Center</h3>
                
                <div class="alert alert-info">
                    <strong>üéØ Purpose:</strong> This tab allows managers to collect and consolidate PM completion data from all employees for comprehensive reporting and oversight.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>üì• Import Employee PM Data:</label>
                        <input type="file" class="form-control" id="employeeDataImport" accept=".json" multiple onchange="importEmployeeData(event)">
                        <small style="color: #666;">Select multiple JSON files exported by employees</small>
                    </div>
                    <div style="display: flex; align-items: end; gap: 10px;">
                        <button class="btn btn-primary" onclick="document.getElementById('employeeDataImport').click()">
                            üìÇ Select Employee Export Files
                        </button>
                        <button class="btn btn-danger" onclick="clearConsolidatedData()">
                            üóëÔ∏è Clear All Imported Data
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="consolidatedEmployeeCount">0</div>
                        <div class="label">Employees Imported</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="consolidatedPMCount">0</div>
                        <div class="label">Total PM Completions</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="consolidatedHoursCount">0</div>
                        <div class="label">Total Hours Worked</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="lastImportDate">None</div>
                        <div class="label">Last Import Date</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìä Consolidated PM Completions (All Employees)</h3>
                    <div>
                        <button class="btn btn-success" onclick="exportConsolidatedReport()">
                            üì§ Export Master Report
                        </button>
                        <button class="btn btn-warning" onclick="exportConsolidatedCSV()">
                            üìã Export to CSV
                        </button>
                        <button class="btn btn-primary" onclick="generateMasterPerformanceReport()">
                            üìà Generate Master Report
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="consolidatedFilter">Filter by Employee:</label>
                        <select class="form-control" id="consolidatedFilter" onchange="filterConsolidatedData()">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateRangeFilter">Date Range:</label>
                        <select class="form-control" id="dateRangeFilter" onchange="filterConsolidatedData()">
                            <option value="">All Dates</option>
                            <option value="thisWeek">This Week</option>
                            <option value="lastWeek">Last Week</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="consolidatedDataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee</th>
                                <th>Equipment (BFM)</th>
                                <th>Description</th>
                                <th>Hours</th>
                                <th>PM Type</th>
                                <th>Notes</th>
                                <th>Import Source</th>
                            </tr>
                        </thead>
                        <tbody id="consolidatedDataBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                                    No employee data imported yet. Import employee export files to see consolidated data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3>üìã Instructions for Data Collection</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4>üë• For Employees:</h4>
                    <ol>
                        <li>Go to the <strong>"PM Completion Entry"</strong> tab</li>
                        <li>Complete your PM entries as normal</li>
                        <li>At the end of each week, click <strong>"üì§ Export My Data"</strong></li>
                        <li>Send the downloaded JSON file to your manager</li>
                    </ol>
                    
                    <h4>üë®‚Äçüíº For Managers:</h4>
                    <ol>
                        <li>Collect JSON export files from all employees</li>
                        <li>Use <strong>"üìÇ Select Employee Export Files"</strong> to import all files at once</li>
                        <li>View consolidated data in the table above</li>
                        <li>Generate master reports for company-wide analysis</li>
                        <li>Export data to CSV for use in other systems</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Performance Reports Tab -->
       <div id="reports" class="tab-content">
           <div class="card">
               <h3>Performance Report Generation</h3>
               <div class="form-row">
                   <div class="form-group">
                       <label for="reportType">Report Type:</label>
                       <select class="form-control" id="reportType">
                           <option value="weekly">Weekly</option>
                           <option value="monthly">Monthly</option>
                           <option value="yearly">Year to Date</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label for="reportDate">Report Date:</label>
                       <input type="date" class="form-control" id="reportDate">
                   </div>
                   <div style="display: flex; align-items: end; gap: 10px;">
                       <button class="btn btn-primary" onclick="generatePerformanceReport()">Generate Report</button>
                       <button class="btn btn-success" onclick="printPerformanceReport()">Print Report</button>
                   </div>
               </div>

               <div id="reportContainer">
                   <!-- Report content will be populated here -->
               </div>
           </div>
       </div>

       <!-- Add Equipment Tab -->
       <div id="add-equipment" class="tab-content">
           <div class="card">
               <h3>Add New Equipment</h3>
               <form id="addEquipmentForm" onsubmit="addNewEquipment(event)">
                   <div class="form-row">
                       <div class="form-group">
                           <label for="newSAP">SAP Material No.:</label>
                           <input type="text" class="form-control" id="newSAP">
                       </div>
                       <div class="form-group">
                           <label for="newBFM">BFM Equipment No.:</label>
                           <input type="text" class="form-control" id="newBFM" required>
                       </div>
                   </div>

                   <div class="form-group">
                       <label for="newDescription">Description:</label>
                       <input type="text" class="form-control" id="newDescription" required>
                   </div>

                   <div class="form-row">
                       <div class="form-group">
                           <label for="newLocation">Site Location:</label>
                           <input type="text" class="form-control" id="newLocation">
                       </div>
                       <div class="form-group">
                           <label for="newFrequency">PM Frequency:</label>
                           <select class="form-control" id="newFrequency" required>
                               <option value="">Select Frequency</option>
                               <option value="Weekly">Weekly</option>
                               <option value="Bi-Monthly">Bi-Monthly</option>
                               <option value="Monthly">Monthly</option>
                               <option value="Quarterly">Quarterly</option>
                               <option value="Six Month">Six Month</option>
                               <option value="Annual">Annual</option>
                           </select>
                       </div>
                   </div>

                   <button type="submit" class="btn btn-success">Add Equipment</button>
               </form>
           </div>

           <div class="card">
               <h3>Recently Added Equipment</h3>
               <div class="table-container">
                   <table class="data-table" id="recentEquipmentTable">
                       <thead>
                           <tr>
                               <th>SAP Material No.</th>
                               <th>BFM Equipment No.</th>
                               <th>Description</th>
                               <th>Location</th>
                               <th>Frequency</th>
                               <th>Date Added</th>
                           </tr>
                       </thead>
                       <tbody id="recentEquipmentBody">
                           <!-- Recent equipment will be populated here -->
                       </tbody>
                   </table>
               </div>
           </div>
       </div>
   </div>

   <!-- Alert Modal -->
   <div id="alertModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 id="alertTitle">Alert</h3>
               <span class="close" onclick="closeModal()">&times;</span>
           </div>
           <div id="alertMessage"></div>
           <div style="text-align: center; margin-top: 20px;">
               <button class="btn btn-primary" onclick="closeModal()">OK</button>
           </div>
       </div>
   </div>

   <script>
       // Global variables for data storage
       let equipmentData = [];
       let pmCompletions = [];
       let weeklySchedule = [];
       let consolidatedEmployeeData = []; // New variable for consolidated data
       let yearlySchedules = {}; // New variable for storing all yearly schedules
       
       // PM Frequencies mapping
       const pmFrequencies = {
           'Weekly': 7,
           'Bi-Monthly': 14,
           'Monthly': 30,
           'Quarterly': 90,
           'Six Month': 180,
           'Annual': 365
       };

       // Pre-loaded equipment data - REPLACE THIS SECTION WITH YOUR ACTUAL EQUIPMENT DATA
       const preloadedEquipmentData = [
           // INSTRUCTIONS: Replace this example data with your actual equipment
           // Copy and paste your equipment data in this exact format:
           //
           // {
           //     id: 1,                                    // Unique number (1, 2, 3, etc.)
           //     sapMaterialNo: "YOUR_SAP_NUMBER",         // Your SAP Material Number
           //     bfmEquipmentNo: "YOUR_BFM_NUMBER",        // Your BFM Equipment Number  
           //     description: "YOUR_EQUIPMENT_DESCRIPTION", // Equipment Description
           //     siteLocation: "YOUR_LOCATION",            // Site Location
           //     lastPMDate: "2024-01-15",                 // Last PM Date (YYYY-MM-DD format)
           //     nextPMDate: "2024-02-15",                 // Next PM Date (YYYY-MM-DD format)
           //     pmFrequency: "Monthly",                   // Weekly, Bi-Monthly, Monthly, Quarterly, Six Month, Annual
           //     createdDate: "2024-01-01"                 // Date added to system (YYYY-MM-DD format)
           // },
           //
           // EXAMPLE - DELETE THIS AND ADD YOUR REAL DATA:
           {
               id: 1,
               sapMaterialNo: "12345678",
               bfmEquipmentNo: "BFM001",
               description: "Example Equipment 1 - DELETE THIS AND ADD YOUR REAL DATA",
               siteLocation: "Building A",
               lastPMDate: "2024-01-15",
               nextPMDate: "2024-02-15",
               pmFrequency: "Monthly",
               createdDate: "2024-01-01"
           },
           {
               id: 2,
               sapMaterialNo: "87654321",
               bfmEquipmentNo: "BFM002", 
               description: "Example Equipment 2 - DELETE THIS AND ADD YOUR REAL DATA",
               siteLocation: "Building B",
               lastPMDate: "2024-01-10",
               nextPMDate: "2024-01-17",
               pmFrequency: "Weekly",
               createdDate: "2024-01-01"
           }
           // TO ADD MORE EQUIPMENT: Copy the pattern above, increment the ID, and add comma after each entry except the last one
       ];

       // Initialize the application
       window.onload = function() {
           // Set default dates
           const completionDateEl = document.getElementById('completionDate');
           const reportDateEl = document.getElementById('reportDate');
           const weekStartEl = document.getElementById('weekStart');
           
           if (completionDateEl) {
               completionDateEl.value = new Date().toISOString().split('T')[0];
           }
           if (reportDateEl) {
               reportDateEl.value = new Date().toISOString().split('T')[0];
           }
           
           // Set default week start (next Monday)
           if (weekStartEl) {
               const today = new Date();
               const nextMonday = new Date(today);
               nextMonday.setDate(today.getDate() + (8 - today.getDay()) % 7);
               weekStartEl.value = nextMonday.toISOString().split('T')[0];
           }
           
           // Load data from localStorage
           loadDataFromStorage();
           loadConsolidatedDataFromStorage();
           
           // If no equipment data exists, load the pre-populated data
           if (equipmentData.length === 0) {
               equipmentData = [...preloadedEquipmentData];
               saveDataToStorage();
               showAlert('Info', 'Equipment data has been loaded automatically. All employees now have access to the same equipment database.');
           }
           
           refreshEquipmentList();
           loadRecentCompletions();
           
           // Only load consolidated data if we're on that tab and element exists
           setTimeout(() => {
               if (document.getElementById('consolidatedDataBody')) {
                   loadConsolidatedData();
               }
           }, 100);
       };

       // Tab management
       function showTab(tabName) {
           // Hide all tabs
           const tabs = document.querySelectorAll('.tab-content');
           tabs.forEach(tab => tab.classList.remove('active'));
           
           // Remove active class from all nav tabs
           const navTabs = document.querySelectorAll('.nav-tab');
           navTabs.forEach(tab => tab.classList.remove('active'));
           
           // Show selected tab
           document.getElementById(tabName).classList.add('active');
           
           // Add active class to clicked nav tab
           event.target.classList.add('active');
       }

       // Data persistence functions
       function saveDataToStorage() {
           localStorage.setItem('pmEquipmentData', JSON.stringify(equipmentData));
           localStorage.setItem('pmCompletions', JSON.stringify(pmCompletions));
           localStorage.setItem('weeklySchedule', JSON.stringify(weeklySchedule));
           localStorage.setItem('yearlySchedules', JSON.stringify(yearlySchedules));
       }

       function loadDataFromStorage() {
           const savedEquipment = localStorage.getItem('pmEquipmentData');
           const savedCompletions = localStorage.getItem('pmCompletions');
           const savedSchedule = localStorage.getItem('weeklySchedule');
           const savedYearlySchedules = localStorage.getItem('yearlySchedules');
           
           if (savedEquipment) {
               equipmentData = JSON.parse(savedEquipment);
           }
           if (savedCompletions) {
               pmCompletions = JSON.parse(savedCompletions);
           }
           if (savedSchedule) {
               weeklySchedule = JSON.parse(savedSchedule);
           }
           if (savedYearlySchedules) {
               yearlySchedules = JSON.parse(savedYearlySchedules);
           }
       }

       function loadConsolidatedDataFromStorage() {
           const savedData = localStorage.getItem('consolidatedEmployeeData');
           if (savedData) {
               try {
                   consolidatedEmployeeData = JSON.parse(savedData);
                   if (typeof updateConsolidatedStats === 'function') {
                       updateConsolidatedStats();
                   }
                   if (typeof updateEmployeeFilter === 'function') {
                       updateEmployeeFilter();
                   }
               } catch (error) {
                   console.error('Error loading consolidated data:', error);
                   consolidatedEmployeeData = [];
               }
           }
       }

       function saveConsolidatedData() {
           localStorage.setItem('consolidatedEmployeeData', JSON.stringify(consolidatedEmployeeData));
           localStorage.setItem('consolidatedDataLastUpdate', new Date().toISOString());
       }

       function updateConsolidatedStats() {
           const employeeCountEl = document.getElementById('consolidatedEmployeeCount');
           const totalPMsEl = document.getElementById('consolidatedPMCount');
           const totalHoursEl = document.getElementById('consolidatedHoursCount');
           const lastUpdateEl = document.getElementById('lastImportDate');
           
           if (employeeCountEl && totalPMsEl && totalHoursEl && lastUpdateEl) {
               const employeeCount = new Set(consolidatedEmployeeData.map(entry => entry.technician)).size;
               const totalPMs = consolidatedEmployeeData.length;
               const totalHours = consolidatedEmployeeData.reduce((sum, entry) => sum + (entry.hoursWorked || 0), 0);
               const lastUpdate = localStorage.getItem('consolidatedDataLastUpdate');
               
               employeeCountEl.textContent = employeeCount;
               totalPMsEl.textContent = totalPMs;
               totalHoursEl.textContent = totalHours.toFixed(1);
               lastUpdateEl.textContent = lastUpdate ? 
                   new Date(lastUpdate).toLocaleDateString() : 'None';
           }
       }

       function updateEmployeeFilter() {
           const select = document.getElementById('consolidatedFilter');
           if (select) {
               const employees = [...new Set(consolidatedEmployeeData.map(entry => entry.technician))].sort();
               
               // Clear existing options except "All Employees"
               select.innerHTML = '<option value="">All Employees</option>';
               
               employees.forEach(employee => {
                   const option = document.createElement('option');
                   option.value = employee;
                   option.textContent = employee;
                   select.appendChild(option);
               });
           }
       }

       // CSV file loading (Administrator function)
       function loadCSVFile(event) {
           const file = event.target.files[0];
           if (!file) return;

           // Show confirmation dialog
           if (!confirm('‚ö†Ô∏è ADMINISTRATOR ACTION\n\nThis will replace ALL equipment data for ALL users.\n\nAre you sure you want to proceed?')) {
               event.target.value = ''; // Clear the file input
               return;
           }

           const reader = new FileReader();
           reader.onload = function(e) {
               try {
                   const csv = e.target.result;
                   const lines = csv.split('\n');
                   const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                   
                   equipmentData = [];
                   
                   for (let i = 1; i < lines.length; i++) {
                       if (lines[i].trim() === '') continue;
                       
                       const values = parseCSVLine(lines[i]);
                       if (values.length < headers.length) continue;
                       
                       const equipment = {};
                       headers.forEach((header, index) => {
                           equipment[header] = values[index] || '';
                       });
                       
                       // Create standardized equipment object
                       const standardEquipment = {
                           id: Date.now() + Math.random(),
                           sapMaterialNo: equipment['(SAP) Material No.'] || equipment['(SAP) Material No. '] || '',
                           bfmEquipmentNo: equipment['(BFM) Equipment No.'] || '',
                           description: equipment['Description'] || '',
                           siteLocation: equipment['Site Location'] || '',
                           lastPMDate: equipment['Last PM Completion Date'] || '',
                           nextPMDate: equipment['Next PM Completion Date'] || '',
                           pmFrequency: determineFrequency(equipment['Last PM Completion Date'], equipment['Next PM Completion Date']) || 'Monthly',
                           createdDate: new Date().toISOString().split('T')[0]
                       };
                       
                       if (standardEquipment.bfmEquipmentNo && standardEquipment.description) {
                           equipmentData.push(standardEquipment);
                       }
                   }
                   
                   // Save to localStorage with a special admin flag
                   localStorage.setItem('pmEquipmentData', JSON.stringify(equipmentData));
                   localStorage.setItem('pmDataLastUpdated', new Date().toISOString());
                   localStorage.setItem('pmDataAdminUpdate', 'true');
                   
                   saveDataToStorage();
                   refreshEquipmentList();
                   
                   showAlert('Administrator Success', 
                       `‚úÖ Equipment database updated successfully!\n\n` +
                       `‚Ä¢ Loaded ${equipmentData.length} equipment records\n` +
                       `‚Ä¢ All employees will now see this updated data\n` +
                       `‚Ä¢ Last updated: ${new Date().toLocaleString()}`
                   );
                   
               } catch (error) {
                   showAlert('Error', `Failed to load CSV file: ${error.message}`);
               }
               
               // Clear the file input
               event.target.value = '';
           };
           reader.readAsText(file);
       }

       // Data synchronization function
       function syncData() {
           const lastUpdated = localStorage.getItem('pmDataLastUpdated');
           const isAdminUpdate = localStorage.getItem('pmDataAdminUpdate');
           
           if (lastUpdated) {
               const updateDate = new Date(lastUpdated).toLocaleString();
               showAlert('Data Sync Status', 
                   `üìä Data Synchronization Status:\n\n` +
                   `‚Ä¢ Equipment Database: ${equipmentData.length} items\n` +
                   `‚Ä¢ PM Completions: ${pmCompletions.length} records\n` +
                   `‚Ä¢ Last Updated: ${updateDate}\n` +
                   `‚Ä¢ Admin Update: ${isAdminUpdate ? 'Yes' : 'No'}\n\n` +
                   `All data is automatically synced when you load the page.`
               );
           } else {
               showAlert('Data Sync Status', 
                   `üìä Using pre-loaded equipment data.\n\n` +
                   `If you don't see your equipment, ask your administrator to upload the latest CSV file.`
               );
           }
       }

       function parseCSVLine(line) {
           const result = [];
           let current = '';
           let inQuotes = false;
           
           for (let i = 0; i < line.length; i++) {
               const char = line[i];
               if (char === '"') {
                   inQuotes = !inQuotes;
               } else if (char === ',' && !inQuotes) {
                   result.push(current.trim());
                   current = '';
               } else {
                   current += char;
               }
           }
           result.push(current.trim());
           return result;
       }

       function determineFrequency(lastPM, nextPM) {
           if (!lastPM || !nextPM) return 'Monthly';
           
           try {
               const lastDate = new Date(lastPM);
               const nextDate = new Date(nextPM);
               const diffDays = (nextDate - lastDate) / (1000 * 60 * 60 * 24);
               
               if (diffDays <= 7) return 'Weekly';
               if (diffDays <= 14) return 'Bi-Monthly';
               if (diffDays <= 35) return 'Monthly';
               if (diffDays <= 100) return 'Quarterly';
               if (diffDays <= 200) return 'Six Month';
               return 'Annual';
           } catch {
               return 'Monthly';
           }
       }

       // Equipment list management
       function refreshEquipmentList() {
           const tbody = document.getElementById('equipmentTableBody');
           tbody.innerHTML = '';
           
           equipmentData.forEach(equipment => {
               const row = tbody.insertRow();
               row.innerHTML = `
                   <td>${equipment.sapMaterialNo}</td>
                   <td>${equipment.bfmEquipmentNo}</td>
                   <td>${equipment.description}</td>
                   <td>${equipment.siteLocation}</td>
                   <td>${equipment.lastPMDate}</td>
                   <td>${equipment.nextPMDate}</td>
                   <td>${equipment.pmFrequency}</td>
               `;
           });
       }

       function filterEquipment() {
           const searchTerm = document.getElementById('equipmentSearchInput').value.toLowerCase();
           const rows = document.querySelectorAll('#equipmentTableBody tr');
           
           rows.forEach(row => {
               const text = row.textContent.toLowerCase();
               row.style.display = text.includes(searchTerm) ? '' : 'none';
           });
       }

       // PM Completion Entry
       function searchEquipmentForPM() {
           const searchTerm = document.getElementById('equipmentSearch').value.toLowerCase();
           const suggestions = document.getElementById('equipmentSuggestions');
           
           if (searchTerm.length < 2) {
               suggestions.style.display = 'none';
               return;
           }
           
           const matches = equipmentData.filter(eq => 
               eq.bfmEquipmentNo.toLowerCase().includes(searchTerm) ||
               eq.sapMaterialNo.toLowerCase().includes(searchTerm) ||
               eq.description.toLowerCase().includes(searchTerm)
           ).slice(0, 10);
           
           if (matches.length > 0) {
               suggestions.innerHTML = matches.map(eq => 
                   `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" 
                         onclick="selectEquipment('${eq.bfmEquipmentNo}', '${eq.description}')">
                       <strong>${eq.bfmEquipmentNo}</strong> - ${eq.description}
                   </div>`
               ).join('');
               suggestions.style.display = 'block';
           } else {
               suggestions.style.display = 'none';
           }
       }

       function selectEquipment(bfmNo, description) {
           document.getElementById('equipmentSearch').value = `${bfmNo} - ${description}`;
           document.getElementById('equipmentSuggestions').style.display = 'none';
       }

       function submitPMCompletion(event) {
           event.preventDefault();
           
           const formData = {
               id: Date.now(),
               technician: document.getElementById('technician').value,
               completionDate: document.getElementById('completionDate').value,
               equipment: document.getElementById('equipmentSearch').value,
               hoursWorked: parseFloat(document.getElementById('hoursWorked').value),
               pmType: document.getElementById('pmType').value,
               notes: document.getElementById('pmNotes').value,
               submittedDate: new Date().toISOString()
           };
           
           // Extract BFM number from equipment selection
           const bfmMatch = formData.equipment.match(/^([^\s-]+)/);
           const bfmNo = bfmMatch ? bfmMatch[1] : '';
           
           // Find and update equipment
           const equipmentIndex = equipmentData.findIndex(eq => eq.bfmEquipmentNo === bfmNo);
           if (equipmentIndex !== -1) {
               equipmentData[equipmentIndex].lastPMDate = formData.completionDate;
               equipmentData[equipmentIndex].nextPMDate = calculateNextPMDate(formData.completionDate, formData.pmType);
           }
           
           // Add to completions
           pmCompletions.unshift(formData);
           
           // Keep only last 100 completions
           if (pmCompletions.length > 100) {
               pmCompletions = pmCompletions.slice(0, 100);
           }
           
           saveDataToStorage();
           
           // Clear form
           document.getElementById('pmCompletionForm').reset();
           document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
           document.getElementById('equipmentSearch').value = '';
           
           loadRecentCompletions();
           refreshEquipmentList();
           showAlert('Success', 'PM completion recorded successfully');
       }

       function calculateNextPMDate(completionDate, pmType) {
           const date = new Date(completionDate);
           const daysToAdd = pmFrequencies[pmType] || 30;
           date.setDate(date.getDate() + daysToAdd);
           return date.toISOString().split('T')[0];
       }

       function loadRecentCompletions() {
           const tbody = document.getElementById('recentCompletionsBody');
           tbody.innerHTML = '';
           
           pmCompletions.slice(0, 20).forEach(completion => {
               const row = tbody.insertRow();
               row.innerHTML = `
                   <td>${completion.completionDate}</td>
                   <td>${completion.technician}</td>
                   <td>${completion.equipment}</td>
                   <td>${completion.hoursWorked}</td>
                   <td>${completion.pmType}</td>
               `;
           });
       }

       // Schedule Generation Functions
       function generateWeeklySchedule() {
           const weekStart = new Date(document.getElementById('weekStart').value);
           const weekEnd = new Date(weekStart);
           weekEnd.setDate(weekEnd.getDate() + 6);
           
           const schedule = generateScheduleForWeek(weekStart);
           weeklySchedule = schedule;
           
           saveDataToStorage();
           loadWeeklySchedule();
           updateScheduleStats();
           
           const frequencyBreakdown = getFrequencyBreakdown(weeklySchedule);
           let breakdownText = Object.entries(frequencyBreakdown)
               .map(([freq, count]) => `${freq}: ${count}`)
               .join(', ');
           
           showAlert('Success', 
               `Generated schedule with ${weeklySchedule.length} PMs for week of ${document.getElementById('weekStart').value}\n\n` +
               `Breakdown: ${breakdownText}`
           );
       }

       // NEW FUNCTION: Generate all schedules for the year
       function generateAllSchedulesForYear() {
           const startDate = new Date(document.getElementById('weekStart').value);
           const year = startDate.getFullYear();
           
           // Clear existing yearly schedules
           yearlySchedules = {};
           
           // Get first Monday of the year
           const firstMonday = new Date(year, 0, 1);
           firstMonday.setDate(firstMonday.getDate() + (8 - firstMonday.getDay()) % 7);
           
           let scheduledCount = 0;
           let totalWeeks = 0;
           
           // Generate schedules for all weeks in the year
           for (let weekStart = new Date(firstMonday); weekStart.getFullYear() === year; weekStart.setDate(weekStart.getDate() + 7)) {
               const weekKey = weekStart.toISOString().split('T')[0];
               const weekSchedule = generateScheduleForWeek(new Date(weekStart));
               
               yearlySchedules[weekKey] = weekSchedule;
               scheduledCount += weekSchedule.length;
               totalWeeks++;
           }
           
           saveDataToStorage();
           
           showAlert('Year Schedule Generated', 
               `‚úÖ Generated schedules for entire year ${year}!\n\n` +
               `‚Ä¢ Total weeks: ${totalWeeks}\n` +
               `‚Ä¢ Total PMs scheduled: ${scheduledCount}\n` +
               `‚Ä¢ Average PMs per week: ${Math.round(scheduledCount / totalWeeks)}\n` +
               `‚Ä¢ Target: ${110 * totalWeeks} PMs\n\n` +
               `All weekly schedules are now available for the year.`
           );
       }

       function generateScheduleForWeek(weekStart) {
           const weekEnd = new Date(weekStart);
           weekEnd.setDate(weekEnd.getDate() + 6);
           
           // Separate equipment by frequency for better distribution
           const equipmentByFrequency = {
               'Weekly': [],
               'Bi-Monthly': [],
               'Monthly': [],
               'Quarterly': [],
               'Six Month': [],
               'Annual': []
           };
           
           // Group equipment by frequency
           equipmentData.forEach(equipment => {
               if (equipmentByFrequency[equipment.pmFrequency]) {
                   equipmentByFrequency[equipment.pmFrequency].push(equipment);
               }
           });
           
           // Calculate target distribution for 110 PMs per week
           const targetDistribution = {
               'Weekly': 30,        // ~27% (every week)
               'Bi-Monthly': 15,    // ~14% (every 2 weeks)
               'Monthly': 25,       // ~23% (monthly spread)
               'Quarterly': 20,     // ~18% (quarterly spread)
               'Six Month': 10,     // ~9% (semi-annual spread)
               'Annual': 10         // ~9% (annual spread)
           };
           
           const scheduledEquipment = [];
           
           // Process each frequency type
           Object.keys(equipmentByFrequency).forEach(frequency => {
               const equipmentList = equipmentByFrequency[frequency];
               const targetCount = targetDistribution[frequency];
               
               if (equipmentList.length === 0) return;
               
               // Calculate priority for each equipment in this frequency
               const equipmentWithPriority = equipmentList.map(equipment => ({
                   ...equipment,
                   priority: calculatePMPriority(equipment.nextPMDate, frequency, weekStart, weekEnd),
                   frequencyType: frequency
               })).filter(eq => eq.priority > 0);
               
               // Sort by priority within frequency
               equipmentWithPriority.sort((a, b) => b.priority - a.priority);
               
               // Take up to target count for this frequency
               const selectedForFrequency = equipmentWithPriority.slice(0, Math.min(targetCount, equipmentWithPriority.length));
               scheduledEquipment.push(...selectedForFrequency);
           });
           
           // If we don't have enough equipment, fill remaining slots with highest priority items
           if (scheduledEquipment.length < 110) {
               const remaining = 110 - scheduledEquipment.length;
               const scheduledIds = new Set(scheduledEquipment.map(eq => eq.id));
               
               const additionalEquipment = equipmentData
                   .filter(eq => !scheduledIds.has(eq.id))
                   .map(equipment => ({
                       ...equipment,
                       priority: calculatePMPriority(equipment.nextPMDate, equipment.pmFrequency, weekStart, weekEnd),
                       frequencyType: equipment.pmFrequency
                   }))
                   .filter(eq => eq.priority > 0)
                   .sort((a, b) => b.priority - a.priority)
                   .slice(0, remaining);
               
               scheduledEquipment.push(...additionalEquipment);
           }
           
           // Sort final schedule by priority
           scheduledEquipment.sort((a, b) => b.priority - a.priority);
           
           // Take final 110 (or available count)
           const finalSchedule = scheduledEquipment.slice(0, Math.min(110, scheduledEquipment.length));
           
           return finalSchedule.map(equipment => ({
               ...equipment,
               weekStart: weekStart.toISOString().split('T')[0],
               status: 'Pending',
               assignedTechnician: '',
               scheduledDate: new Date().toISOString()
           }));
       }
       
       function updateScheduleStats() {
           const scheduledCount = weeklySchedule.length;
           const targetCount = 110;
           const percentage = Math.round((scheduledCount / targetCount) * 100);
           
           document.getElementById('scheduledPMCount').textContent = scheduledCount;
           document.getElementById('completionPercentage').textContent = `${percentage}%`;
       }
       
       function getFrequencyBreakdown(schedule) {
           const breakdown = {
               'Weekly': 0,
               'Bi-Monthly': 0,
               'Monthly': 0,
               'Quarterly': 0,
               'Six Month': 0,
               'Annual': 0
           };
           
           schedule.forEach(item => {
               if (breakdown.hasOwnProperty(item.pmFrequency)) {
                   breakdown[item.pmFrequency]++;
               }
           });
           
           return breakdown;
       }

       function calculatePMPriority(nextPMDate, frequency, weekStart, weekEnd) {
           try {
               const currentDate = new Date();
               const nextPM = nextPMDate ? new Date(nextPMDate) : null;
               
               // If no next PM date, calculate based on frequency and current date
               if (!nextPM) {
                   const daysFromFrequency = pmFrequencies[frequency] || 30;
                   const estimatedNextPM = new Date(currentDate);
                   estimatedNextPM.setDate(currentDate.getDate() + daysFromFrequency);
                   return calculatePriorityFromDate(estimatedNextPM, frequency, weekStart, weekEnd);
               }
               
               return calculatePriorityFromDate(nextPM, frequency, weekStart, weekEnd);
           } catch {
               return calculateFrequencyBasedPriority(frequency, weekStart);
           }
       }

       function calculatePriorityFromDate(pmDate, frequency, weekStart, weekEnd) {
           // Overdue items (highest priority)
           if (pmDate < weekStart) {
               const daysOverdue = Math.floor((weekStart - pmDate) / (1000 * 60 * 60 * 24));
               return 1000 + daysOverdue;
           }
           
           // Due this week (high priority)
           if (pmDate >= weekStart && pmDate <= weekEnd) {
               return 500 + getFrequencyBonus(frequency);
           }
           
           // Due within next 2 weeks
           const twoWeeksOut = new Date(weekEnd);
           twoWeeksOut.setDate(weekEnd.getDate() + 14);
           if (pmDate <= twoWeeksOut) {
               return 300 + getFrequencyBonus(frequency);
           }
           
           // Due within next month
           const oneMonthOut = new Date(weekEnd);
           oneMonthOut.setDate(weekEnd.getDate() + 30);
           if (pmDate <= oneMonthOut) {
               return 200 + getFrequencyBonus(frequency);
           }
           
           // Due within next 3 months (for scheduling ahead)
           const threeMonthsOut = new Date(weekEnd);
           threeMonthsOut.setDate(weekEnd.getDate() + 90);
           if (pmDate <= threeMonthsOut) {
               return 100 + getFrequencyBonus(frequency);
           }
           
           return getFrequencyBasedPriority(frequency, weekStart);
       }

       function getFrequencyBonus(frequency) {
           // Give higher priority to more frequent PMs
           switch (frequency) {
               case 'Weekly': return 50;
               case 'Bi-Monthly': return 40;
               case 'Monthly': return 30;
               case 'Quarterly': return 20;
               case 'Six Month': return 15;
               case 'Annual': return 10;
               default: return 0;
           }
       }

       function calculateFrequencyBasedPriority(frequency, weekStart) {
           // Calculate if this frequency type should be scheduled this week
           const weekNumber = getWeekNumber(weekStart);
           
           switch (frequency) {
               case 'Weekly':
                   return 400; // Always include weeklies
                   
               case 'Bi-Monthly':
                   // Schedule bi-monthly every 2 weeks
                   return (weekNumber % 2 === 0) ? 350 : 0;
                   
               case 'Monthly':
                   // Distribute monthly PMs across 4 weeks of the month
                   const monthlyGroup = weekNumber % 4;
                   return monthlyGroup === 1 ? 300 : 0;
                   
               case 'Quarterly':
                   // Schedule quarterly PMs once every 13 weeks
                   return (weekNumber % 13 === 0) ? 250 : 0;
                   
               case 'Six Month':
                   // Schedule six-month PMs twice per year (weeks 1 and 26)
                   return (weekNumber === 1 || weekNumber === 26) ? 200 : 0;
                   
               case 'Annual':
                   // Distribute annual PMs throughout the year
                   const annualWeek = weekNumber % 52;
                   return (annualWeek <= 50) ? 150 : 0;
                   
               default:
                   return 0;
           }
       }

       function loadWeeklySchedule() {
           const tbody = document.getElementById('scheduleTableBody');
           tbody.innerHTML = '';
           
           // Group by frequency for better visualization
           const groupedSchedule = {};
           weeklySchedule.forEach(item => {
               if (!groupedSchedule[item.pmFrequency]) {
                   groupedSchedule[item.pmFrequency] = [];
               }
               groupedSchedule[item.pmFrequency].push(item);
           });
           
           // Display in frequency order
           const frequencyOrder = ['Weekly', 'Bi-Monthly', 'Monthly', 'Quarterly', 'Six Month', 'Annual'];
           
           frequencyOrder.forEach(frequency => {
               if (groupedSchedule[frequency]) {
                   // Add frequency header row
                   const headerRow = tbody.insertRow();
                   headerRow.innerHTML = `
                       <td colspan="6" style="background: #1a365d; color: white; font-weight: bold; text-align: center; padding: 10px;">
                           ${frequency} PMs (${groupedSchedule[frequency].length} items)
                       </td>
                   `;
                   
                   // Add equipment rows for this frequency
                   groupedSchedule[frequency].forEach(item => {
                       const row = tbody.insertRow();
                       const priorityText = item.priority > 1000 ? 'Overdue' : 
                                          item.priority > 500 ? 'Due This Week' : 
                                          item.priority > 300 ? 'Due Soon' : 
                                          item.priority > 200 ? 'Due This Month' :
                                          item.priority > 100 ? 'Due Next 3 Months' : 'Scheduled';
                       
                       row.innerHTML = `
                           <td>${item.bfmEquipmentNo}</td>
                           <td>${item.description}</td>
                           <td>${item.siteLocation}</td>
                           <td>${item.pmFrequency}</td>
                           <td>${item.status}</td>
                           <td>${priorityText}</td>
                       `;
                       
                       // Color coding based on priority
                       if (item.priority > 1000) {
                           row.style.backgroundColor = '#fee';
                       } else if (item.priority > 500) {
                           row.style.backgroundColor = '#fef0e6';
                       } else if (item.priority > 300) {
                           row.style.backgroundColor = '#fff8e1';
                       }
                   });
               }
           });
           
           // If no schedule, show message
           if (weeklySchedule.length === 0) {
               const row = tbody.insertRow();
               row.innerHTML = `
                   <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                       No PMs scheduled. Click "Generate Weekly Schedule" to create a schedule.
                   </td>
               `;
           }
       }

       function printSchedule() {
           if (weeklySchedule.length === 0) {
               showAlert('Warning', 'No schedule generated. Please generate a schedule first.');
               return;
           }
           
           const printWindow = window.open('', '_blank');
           const weekStart = document.getElementById('weekStart').value;
           
           printWindow.document.write(`
               <html>
               <head>
                   <title>Weekly PM Schedule - ${weekStart}</title>
                   <style>
                       body { font-family: Arial, sans-serif; margin: 20px; }
                       .header { text-align: center; margin-bottom: 30px; }
                       .header h1 { color: #1a365d; }
                       table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                       th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                       th { background-color: #1a365d; color: white; }
                       .overdue { background-color: #fee; }
                       .due-soon { background-color: #fef0e6; }
                       .stats { margin-bottom: 20px; }
                       .stats div { display: inline-block; margin-right: 30px; font-weight: bold; }
                   </style>
               </head>
               <body>
                   <div class="header">
                       <h1>AIRBUS AIT - Weekly PM Schedule</h1>
                       <h2>Week Starting: ${weekStart}</h2>
                   </div>
                   
                   <div class="stats">
                       <div>Total PMs Scheduled: ${weeklySchedule.length}</div>
                       <div>Target: 110 PMs</div>
                       <div>Achievement: ${Math.round((weeklySchedule.length / 110) * 100)}%</div>
                   </div>
                   
                   <table>
                       <thead>
                           <tr>
                               <th>BFM Equipment No.</th>
                               <th>Description</th>
                               <th>Location</th>
                               <th>PM Frequency</th>
                               <th>Priority</th>
                               <th>Technician</th>
                               <th>Completed</th>
                           </tr>
                       </thead>
                       <tbody>
           `);
           
           weeklySchedule.forEach(item => {
               const priorityText = item.priority > 1000 ? 'Overdue' : 
                                  item.priority > 500 ? 'Due This Week' : 
                                  item.priority > 100 ? 'Due Soon' : 'Scheduled';
               const rowClass = item.priority > 1000 ? 'overdue' : item.priority > 500 ? 'due-soon' : '';
               
               printWindow.document.write(`
                   <tr class="${rowClass}">
                       <td>${item.bfmEquipmentNo}</td>
                       <td>${item.description}</td>
                       <td>${item.siteLocation}</td>
                       <td>${item.pmFrequency}</td>
                       <td>${priorityText}</td>
                       <td></td>
                       <td>‚ñ°</td>
                   </tr>
               `);
           });
           
           printWindow.document.write(`
                       </tbody>
                   </table>
                   <div style="margin-top: 30px; font-size: 12px; color: #666;">
                       Generated on: ${new Date().toLocaleString()}
                   </div>
               </body>
               </html>
           `);
           
           printWindow.document.close();
           printWindow.print();
       }

       // Equipment Search
       function performSearch() {
           const criteria = document.getElementById('searchCriteria').value;
           const term = document.getElementById('searchTerm').value.toLowerCase();
           const tbody = document.getElementById('searchResultsBody');
           
           tbody.innerHTML = '';
           
           if (!term && criteria !== 'all') return;
           
           const filteredEquipment = equipmentData.filter(equipment => {
               if (criteria === 'all' || !term) return true;
               
               switch (criteria) {
                   case 'sap':
                       return equipment.sapMaterialNo.toLowerCase().includes(term);
                   case 'bfm':
                       return equipment.bfmEquipmentNo.toLowerCase().includes(term);
                   case 'description':
                       return equipment.description.toLowerCase().includes(term);
                   case 'location':
                       return equipment.siteLocation.toLowerCase().includes(term);
                   default:
                       return true;
               }
           });
           
           filteredEquipment.forEach(equipment => {
               const row = tbody.insertRow();
               row.innerHTML = `
                   <td>${equipment.sapMaterialNo}</td>
                   <td>${equipment.bfmEquipmentNo}</td>
                   <td>${equipment.description}</td>
                   <td>${equipment.siteLocation}</td>
                   <td>${equipment.lastPMDate}</td>
                   <td>${equipment.nextPMDate}</td>
               `;
           });
       }

       // Data Management Functions
       function importEmployeeData(event) {
           const files = event.target.files;
           if (!files || files.length === 0) return;
           
           let importCount = 0;
           let errorCount = 0;
           const processedFiles = [];
           
           Array.from(files).forEach(file => {
               const reader = new FileReader();
               reader.onload = function(e) {
                   try {
                       const data = JSON.parse(e.target.result);
                       
                       if (data.exportType === 'employee_pm_completions' && data.completions) {
                           data.completions.forEach(completion => {
                               const consolidatedEntry = {
                                   ...completion,
                                   importedFrom: data.employeeName || 'Unknown Employee',
                                   sourceFile: file.name,
                                   importDate: new Date().toISOString()
                               };
                               
                               // Check for duplicates based on technician, date, and equipment
                               const isDuplicate = consolidatedEmployeeData.some(existing => 
                                   existing.technician === consolidatedEntry.technician &&
                                   existing.completionDate === consolidatedEntry.completionDate &&
                                   existing.equipment === consolidatedEntry.equipment
                               );
                               
                               if (!isDuplicate) {
                                   consolidatedEmployeeData.push(consolidatedEntry);
                                   importCount++;
                               }
                           });
                           
                           processedFiles.push(file.name);
                       } else {
                           errorCount++;
                       }
                   } catch (error) {
                       errorCount++;
                       console.error('Error processing file:', file.name, error);
                   }
                   
                   // Check if all files are processed
                   if (processedFiles.length + errorCount === files.length) {
                       saveConsolidatedData();
                       updateConsolidatedStats();
                       updateEmployeeFilter();
                       loadConsolidatedData();
                       
                       showAlert('Import Complete', 
                           `üì• Employee data import completed!\n\n` +
                           `‚Ä¢ Files processed: ${processedFiles.length}\n` +
                           `‚Ä¢ Records imported: ${importCount}\n` +
                           `‚Ä¢ Errors: ${errorCount}\n\n` +
                           `Consolidated data has been updated.`
                       );
                   }
               };
               reader.readAsText(file);
           });
           
           // Clear the file input
           event.target.value = '';
       }

       function loadConsolidatedData() {
           const tbody = document.getElementById('consolidatedDataBody');
           if (!tbody) return; // Element doesn't exist, exit gracefully
           
           tbody.innerHTML = '';
           
           const filterEmployee = document.getElementById('consolidatedFilter')?.value || '';
           const filterDateRange = document.getElementById('dateRangeFilter')?.value || '';
           
           let filteredData = [...consolidatedEmployeeData];
           
           // Apply employee filter
           if (filterEmployee) {
               filteredData = filteredData.filter(entry => entry.technician === filterEmployee);
           }
           
           // Apply date range filter
           if (filterDateRange) {
               const today = new Date();
               let startDate, endDate;
               
               switch (filterDateRange) {
                   case 'thisWeek':
                       startDate = new Date(today);
                       startDate.setDate(today.getDate() - today.getDay() + 1);
                       endDate = new Date(startDate);
                       endDate.setDate(startDate.getDate() + 6);
                       break;
                   case 'lastWeek':
                       endDate = new Date(today);
                       endDate.setDate(today.getDate() - today.getDay());
                       startDate = new Date(endDate);
                       startDate.setDate(endDate.getDate() - 6);
                       break;
                   case 'thisMonth':
                       startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                       endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                       break;
                   case 'lastMonth':
                       startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                       endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                       break;
               }
               
               if (startDate && endDate) {
                   filteredData = filteredData.filter(entry => {
                       const entryDate = new Date(entry.completionDate);
                       return entryDate >= startDate && entryDate <= endDate;
                   });
               }
           }
           
           // Sort by date (newest first)
           filteredData.sort((a, b) => new Date(b.completionDate) - new Date(a.completionDate));
           
           if (filteredData.length === 0) {
               const row = tbody.insertRow();
               row.innerHTML = `
                   <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                       No data matches the current filters.
                   </td>
               `;
               return;
           }
           
           filteredData.forEach(entry => {
               const row = tbody.insertRow();
               const equipmentParts = entry.equipment.split(' - ');
               const bfmNo = equipmentParts[0] || '';
               const description = equipmentParts[1] || entry.equipment;
               
               row.innerHTML = `
                   <td>${entry.completionDate}</td>
                   <td>${entry.technician}</td>
                   <td>${bfmNo}</td>
                   <td>${description}</td>
                   <td>${entry.hoursWorked}</td>
                   <td>${entry.pmType}</td>
                   <td>${entry.notes || ''}</td>
                   <td>${entry.importedFrom} (${entry.sourceFile})</td>
               `;
           });
       }

       function filterConsolidatedData() {
           loadConsolidatedData();
       }

       function exportConsolidatedReport() {
           if (consolidatedEmployeeData.length === 0) {
               showAlert('No Data', 'No consolidated data to export. Import employee files first.');
               return;
           }
           
           const reportData = {
               reportType: 'consolidated_master_report',
               generatedDate: new Date().toISOString(),
               totalEmployees: new Set(consolidatedEmployeeData.map(e => e.technician)).size,
               totalCompletions: consolidatedEmployeeData.length,
               totalHours: consolidatedEmployeeData.reduce((sum, e) => sum + (e.hoursWorked || 0), 0),
               dateRange: {
                   earliest: Math.min(...consolidatedEmployeeData.map(e => new Date(e.completionDate))),
                   latest: Math.max(...consolidatedEmployeeData.map(e => new Date(e.completionDate)))
               },
               employeeSummary: generateEmployeeSummary(),
               pmTypeSummary: generatePMTypeSummary(),
               completions: consolidatedEmployeeData
           };
           
           const dataStr = JSON.stringify(reportData, null, 2);
           const dataBlob = new Blob([dataStr], {type: 'application/json'});
           const url = URL.createObjectURL(dataBlob);
           
           const link = document.createElement('a');
           link.href = url;
           link.download = `Master_PM_Report_${new Date().toISOString().split('T')[0]}.json`;
           link.click();
           
           URL.revokeObjectURL(url);
           showAlert('Export Complete', 'Master report exported successfully.');
       }
       
       function exportConsolidatedCSV() {
           if (consolidatedEmployeeData.length === 0) {
               showAlert('No Data', 'No consolidated data to export. Import employee files first.');
               return;
           }
           
           const headers = ['Date', 'Employee', 'BFM Equipment No', 'Equipment Description', 'Hours Worked', 'PM Type', 'Notes', 'Imported From'];
           const csvContent = [headers.join(',')];
           
           consolidatedEmployeeData.forEach(entry => {
               const equipmentParts = entry.equipment.split(' - ');
               const bfmNo = equipmentParts[0] || '';
               const description = equipmentParts[1] || entry.equipment;
               
               const row = [
                   entry.completionDate,
                   `"${entry.technician}"`,
                   `"${bfmNo}"`,
                   `"${description}"`,
                   entry.hoursWorked,
                   `"${entry.pmType}"`,
                   `"${(entry.notes || '').replace(/"/g, '""')}"`,
                   `"${entry.importedFrom}"`
               ];
               csvContent.push(row.join(','));
           });
           
           const csvBlob = new Blob([csvContent.join('\n')], {type: 'text/csv'});
           const url = URL.createObjectURL(csvBlob);
           
           const link = document.createElement('a');
           link.href = url;
           link.download = `Consolidated_PM_Data_${new Date().toISOString().split('T')[0]}.csv`;
           link.click();
           
           URL.revokeObjectURL(url);
           showAlert('CSV Export Complete', 'Consolidated data exported to CSV successfully.');
       }
       
       function generateEmployeeSummary() {
           const summary = {};
           consolidatedEmployeeData.forEach(entry => {
               if (!summary[entry.technician]) {
                   summary[entry.technician] = {
                       totalCompletions: 0,
                       totalHours: 0,
                       pmTypes: {}
                   };
               }
               summary[entry.technician].totalCompletions++;
               summary[entry.technician].totalHours += entry.hoursWorked || 0;
               
               const pmType = entry.pmType || 'Unknown';
               summary[entry.technician].pmTypes[pmType] = (summary[entry.technician].pmTypes[pmType] || 0) + 1;
           });
           return summary;
       }
       
       function generatePMTypeSummary() {
           const summary = {};
           consolidatedEmployeeData.forEach(entry => {
               const pmType = entry.pmType || 'Unknown';
               if (!summary[pmType]) {
                   summary[pmType] = {
                       count: 0,
                       totalHours: 0,
                       employees: new Set()
                   };
               }
               summary[pmType].count++;
               summary[pmType].totalHours += entry.hoursWorked || 0;
               summary[pmType].employees.add(entry.technician);
           });
           
           // Convert Set to Array for JSON serialization
           Object.keys(summary).forEach(pmType => {
               summary[pmType].employees = Array.from(summary[pmType].employees);
           });
           
           return summary;
       }
       
       function generateMasterPerformanceReport() {
           if (consolidatedEmployeeData.length === 0) {
               showAlert('No Data', 'No consolidated data available. Import employee files first.');
               return;
           }
           
           // Calculate report data
           const employeeSummary = generateEmployeeSummary();
           const pmTypeSummary = generatePMTypeSummary();
           const totalEmployees = Object.keys(employeeSummary).length;
           const totalCompletions = consolidatedEmployeeData.length;
           const totalHours = consolidatedEmployeeData.reduce((sum, e) => sum + (e.hoursWorked || 0), 0);
           
           // Generate detailed report display
           const container = document.getElementById('reportContainer');
           if (!container) return;
           
           container.innerHTML = `
               <div class="card">
                   <h3>üìä Master Performance Report - All Employees</h3>
                   
                   <div class="stats-grid">
                       <div class="stat-card">
                           <div class="number">${totalEmployees}</div>
                           <div class="label">Active Employees</div>
                       </div>
                       <div class="stat-card">
                           <div class="number">${totalCompletions}</div>
                           <div class="label">Total PMs Completed</div>
                       </div>
                       <div class="stat-card">
                           <div class="number">${totalHours.toFixed(1)}</div>
                           <div class="label">Total Hours Worked</div>
                       </div>
                       <div class="stat-card">
                           <div class="number">${(totalHours / totalEmployees).toFixed(1)}</div>
                           <div class="label">Avg Hours per Employee</div>
                       </div>
                   </div>
                   
                   <div class="employee-grid">
                       ${Object.entries(employeeSummary).map(([employee, data]) => `
                           <div class="employee-card">
                               <div class="name">${employee}</div>
                               <div class="count">${data.totalCompletions} PMs</div>
                               <div style="font-size: 0.9em; opacity: 0.8;">${data.totalHours.toFixed(1)} hours</div>
                           </div>
                       `).join('')}
                   </div>
                   
                   <div style="margin-top: 30px;">
                       <h4>PM Type Breakdown</h4>
                       <div class="stats-grid">
                           ${Object.entries(pmTypeSummary).map(([pmType, data]) => `
                               <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                   <div style="font-weight: bold; color: #1a365d; font-size: 1.2em;">${data.count}</div>
                                   <div style="font-size: 0.9em; color: #666;">${pmType}</div>
                                   <div style="font-size: 0.8em; color: #888;">${data.totalHours.toFixed(1)} hrs</div>
                               </div>
                           `).join('')}
                       </div>
                   </div>
               </div>
           `;
           
           // Switch to reports tab
           showTab('reports');
           
           showAlert('Master Report Generated', 
               `üìà Master performance report generated successfully!\n\n` +
               `‚Ä¢ ${totalEmployees} employees analyzed\n` +
               `‚Ä¢ ${totalCompletions} total PM completions\n` +
               `‚Ä¢ ${totalHours.toFixed(1)} total hours worked`
           );
       }
       
       function clearConsolidatedData() {
           if (!confirm('‚ö†Ô∏è Are you sure you want to clear all imported employee data?\n\nThis action cannot be undone.')) {
               return;
           }
           
           consolidatedEmployeeData = [];
           localStorage.removeItem('consolidatedEmployeeData');
           localStorage.removeItem('consolidatedDataLastUpdate');
           
           updateConsolidatedStats();
           loadConsolidatedData();
           updateEmployeeFilter();
           
           showAlert('Data Cleared', 'All consolidated employee data has been cleared.');
       }

       // Performance Reports
       function generatePerformanceReport() {
           const reportType = document.getElementById('reportType').value;
           const reportDate = new Date(document.getElementById('reportDate').value);
           
           let startDate, endDate, periodTitle, plannedPMs;
           
           if (reportType === 'weekly') {
               startDate = new Date(reportDate);
               startDate.setDate(reportDate.getDate() - reportDate.getDay() + 1); // Monday
               endDate = new Date(startDate);
               endDate.setDate(startDate.getDate() + 6);
               periodTitle = `THIS WEEK ${getWeekNumber(startDate)}`;
               plannedPMs = 110;
           } else if (reportType === 'monthly') {
               startDate = new Date(reportDate.getFullYear(), reportDate.getMonth(), 1);
               endDate = new Date(reportDate.getFullYear(), reportDate.getMonth() + 1, 0);
               periodTitle = `THIS MONTH ${reportDate.getMonth() + 1}`;
               plannedPMs = 476;
           } else {
               startDate = new Date(reportDate.getFullYear(), 0, 1);
               endDate = reportDate;
               periodTitle = `YEAR to DATE ${reportDate.getFullYear()}`;
               const daysInYear = 365;
               const daysElapsed = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
               plannedPMs = Math.floor((daysElapsed / daysInYear) * 5720);
           }
           
           // Filter completions for the period
           const periodCompletions = pmCompletions.filter(completion => {
               const compDate = new Date(completion.completionDate);
               return compDate >= startDate && compDate <= endDate;
           });
           
           const totalPMs = periodCompletions.length;
           const totalHours = periodCompletions.reduce((sum, c) => sum + c.hoursWorked, 0);
           const completionRate = Math.round((totalPMs / plannedPMs) * 100);
           
           // Get PM counts by frequency
           const pmByFrequency = {
               'Weekly': 0,
               'Bi-Monthly': 0,
               'Monthly': 0,
               'Quarterly': 0,
               'Six Month': 0,
               'Annual': 0
           };
           
           periodCompletions.forEach(completion => {
               if (pmByFrequency.hasOwnProperty(completion.pmType)) {
                   pmByFrequency[completion.pmType]++;
               }
           });
           
           // Get employee counts
           const employeeCounts = {};
           const employees = ['Rey Marikit', 'James Dunnam', 'Jerone Bosarge', 'Mark Michaels',
                            'Nick Whisenant', 'Wayne Dunnam', 'Ronnie Hugh', 'John Hymel', 'Nate Williams'];
           
           employees.forEach(emp => employeeCounts[emp] = 0);
           
           periodCompletions.forEach(completion => {
               if (employeeCounts.hasOwnProperty(completion.technician)) {
                   employeeCounts[completion.technician]++;
               }
           });
           
           displayPerformanceReport(periodTitle, totalPMs, plannedPMs, completionRate, totalHours, pmByFrequency, employeeCounts);
       }

       function displayPerformanceReport(periodTitle, totalPMs, plannedPMs, completionRate, totalHours, pmByFrequency, employeeCounts) {
           const container = document.getElementById('reportContainer');
           
           const completionClass = completionRate >= 90 ? 'green' : completionRate >= 70 ? 'yellow' : 'red';
           
           container.innerHTML = `
               <div class="stats-grid">
                   <div class="stat-card">
                       <div class="number">${totalPMs}</div>
                       <div class="label">PMs Performed</div>
                   </div>
                   <div class="stat-card">
                       <div class="number">${plannedPMs}</div>
                       <div class="label">Planned PMs</div>
                   </div>
                   <div class="stat-card">
                       <div class="number">${totalHours.toFixed(1)}</div>
                       <div class="label">PM Hours</div>
                   </div>
                   <div class="stat-card">
                       <div class="number">${Math.max(0, plannedPMs - totalPMs)}</div>
                       <div class="label">Remaining PMs</div>
                   </div>
               </div>
               
               <div class="completion-rate ${completionClass}">
                   <div class="rate">${completionRate}%</div>
                   <div class="label">COMPLETION RATE</div>
               </div>
               
               <div class="card">
                   <h3>PM Breakdown by Frequency</h3>
                   <div class="stats-grid">
                       ${Object.entries(pmByFrequency).map(([freq, count]) => `
                           <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                               <span style="font-weight: 600;">${freq} PMs:</span>
                               <span style="font-size: 1.4em; font-weight: bold; color: #1a365d;">${count}</span>
                           </div>
                       `).join('')}
                   </div>
               </div>
               
               <div class="card">
                   <h3>PMs Completed Per Employee</h3>
                   <div class="employee-grid">
                       ${Object.entries(employeeCounts).map(([emp, count]) => `
                           <div class="employee-card">
                               <div class="name">${emp}</div>
                               <div class="count">${count}</div>
                           </div>
                       `).join('')}
                   </div>
               </div>
           `;
       }

       function printPerformanceReport() {
           const container = document.getElementById('reportContainer');
           if (!container.innerHTML.trim()) {
               showAlert('Warning', 'No report generated. Please generate a report first.');
               return;
           }
           
           const printWindow = window.open('', '_blank');
           const reportType = document.getElementById('reportType').value;
           const reportDate = document.getElementById('reportDate').value;
           
           printWindow.document.write(`
               <html>
               <head>
                   <title>Performance Report - ${reportType} - ${reportDate}</title>
                   <style>
                       body { font-family: Arial, sans-serif; margin: 20px; }
                       .header { text-align: center; margin-bottom: 30px; }
                       .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
                       .stat-card { background: #f8f9fa; padding: 20px; text-align: center; border-radius: 8px; }
                       .stat-card .number { font-size: 2em; font-weight: bold; color: #1a365d; }
                       .completion-rate { text-align: center; padding: 30px; margin: 20px 0; border-radius: 10px; }
                       .completion-rate.green { background: #38a169; color: white; }
                       .completion-rate.yellow { background: #d69e2e; color: white; }
                       .completion-rate.red { background: #e53e3e; color: white; }
                       .completion-rate .rate { font-size: 3em; font-weight: bold; }
                       .employee-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
                       .employee-card { background: #1a365d; color: white; padding: 15px; text-align: center; border-radius: 8px; }
                       .employee-card .count { font-size: 1.5em; font-weight: bold; }
                   </style>
               </head>
               <body>
                   <div class="header">
                       <h1>AIRBUS AIT - Performance Report</h1>
                       <h2>${reportType.toUpperCase()} - ${reportDate}</h2>
                   </div>
                   ${container.innerHTML}
                   <div style="margin-top: 30px; font-size: 12px; color: #666;">
                       Generated on: ${new Date().toLocaleString()}
                   </div>
               </body>
               </html>
           `);
           
           printWindow.document.close();
           printWindow.print();
       }

       // Add New Equipment
       function addNewEquipment(event) {
           event.preventDefault();
           
           const newEquipment = {
               id: Date.now(),
               sapMaterialNo: document.getElementById('newSAP').value,
               bfmEquipmentNo: document.getElementById('newBFM').value,
               description: document.getElementById('newDescription').value,
               siteLocation: document.getElementById('newLocation').value,
               pmFrequency: document.getElementById('newFrequency').value,
               lastPMDate: '',
               nextPMDate: calculateNextPMDate(new Date().toISOString().split('T')[0], document.getElementById('newFrequency').value),
               createdDate: new Date().toISOString().split('T')[0]
           };
           
           equipmentData.push(newEquipment);
           saveDataToStorage();
           
           // Clear form
           document.getElementById('addEquipmentForm').reset();
           
           refreshEquipmentList();
           loadRecentAdditions();
           showAlert('Success', 'Equipment added successfully');
       }

       function loadRecentAdditions() {
           const tbody = document.getElementById('recentEquipmentBody');
           tbody.innerHTML = '';
           
           // Get equipment added in last 30 days
           const thirtyDaysAgo = new Date();
           thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
           
           const recentEquipment = equipmentData
               .filter(eq => new Date(eq.createdDate) >= thirtyDaysAgo)
               .sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate))
               .slice(0, 20);
           
           recentEquipment.forEach(equipment => {
               const row = tbody.insertRow();
               row.innerHTML = `
                   <td>${equipment.sapMaterialNo}</td>
                   <td>${equipment.bfmEquipmentNo}</td>
                   <td>${equipment.description}</td>
                   <td>${equipment.siteLocation}</td>
                   <td>${equipment.pmFrequency}</td>
                   <td>${equipment.createdDate}</td>
               `;
           });
       }

       // Employee data export functions
       function exportMyCompletions() {
           if (pmCompletions.length === 0) {
               showAlert('No Data', 'You have no PM completions to export. Complete some PMs first.');
               return;
           }
           
           const currentUser = getCurrentUserName();
           const exportData = {
               employeeName: currentUser,
               exportDate: new Date().toISOString(),
               exportType: 'employee_pm_completions',
               completions: pmCompletions,
               totalCompletions: pmCompletions.length,
               totalHours: pmCompletions.reduce((sum, c) => sum + c.hoursWorked, 0),
               dateRange: {
                   earliest: pmCompletions.length > 0 ? Math.min(...pmCompletions.map(c => new Date(c.completionDate))) : null,
                   latest: pmCompletions.length > 0 ? Math.max(...pmCompletions.map(c => new Date(c.completionDate))) : null
               }
           };
           
           const dataStr = JSON.stringify(exportData, null, 2);
           const dataBlob = new Blob([dataStr], {type: 'application/json'});
           const url = URL.createObjectURL(dataBlob);
           
           const link = document.createElement('a');
           link.href = url;
           link.download = `PM_Data_${currentUser.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
           link.click();
           
           URL.revokeObjectURL(url);
           
           showAlert('Export Complete', 
               `üì§ Your PM completion data has been exported!\n\n` +
               `‚Ä¢ File: PM_Data_${currentUser.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json\n` +
               `‚Ä¢ Total Completions: ${exportData.totalCompletions}\n` +
               `‚Ä¢ Total Hours: ${exportData.totalHours.toFixed(1)}\n\n` +
               `üìß Send this file to your manager for consolidated reporting.`
           );
       }
       
       function exportWeeklyReport() {
           const today = new Date();
           const weekStart = new Date(today);
           weekStart.setDate(today.getDate() - today.getDay() + 1); // Monday
           const weekEnd = new Date(weekStart);
           weekEnd.setDate(weekStart.getDate() + 6); // Sunday
           
           const weeklyCompletions = pmCompletions.filter(completion => {
               const compDate = new Date(completion.completionDate);
               return compDate >= weekStart && compDate <= weekEnd;
           });
           
           if (weeklyCompletions.length === 0) {
               showAlert('No Data', 'You have no PM completions for this week.');
               return;
           }
           
           const currentUser = getCurrentUserName();
           const exportData = {
               employeeName: currentUser,
               reportType: 'weekly_report',
               weekStart: weekStart.toISOString().split('T')[0],
               weekEnd: weekEnd.toISOString().split('T')[0],
               exportDate: new Date().toISOString(),
               completions: weeklyCompletions,
               summary: {
                   totalCompletions: weeklyCompletions.length,
                   totalHours: weeklyCompletions.reduce((sum, c) => sum + c.hoursWorked, 0),
                   pmTypeBreakdown: getCompletionBreakdown(weeklyCompletions)
               }
           };
           
           const dataStr = JSON.stringify(exportData, null, 2);
           const dataBlob = new Blob([dataStr], {type: 'application/json'});
           const url = URL.createObjectURL(dataBlob);
           
           const link = document.createElement('a');
           link.href = url;
           link.download = `Weekly_Report_${currentUser.replace(/\s+/g, '_')}_Week_${weekStart.toISOString().split('T')[0]}.json`;
           link.click();
           
           URL.revokeObjectURL(url);
           
           showAlert('Weekly Report Exported', 
               `üìä Your weekly report has been exported!\n\n` +
               `‚Ä¢ Week: ${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}\n` +
               `‚Ä¢ Completions: ${exportData.summary.totalCompletions}\n` +
               `‚Ä¢ Hours: ${exportData.summary.totalHours.toFixed(1)}`
           );
       }
       
       function getCurrentUserName() {
           // Try to get the most recent technician name from completions
           if (pmCompletions.length > 0) {
               return pmCompletions[0].technician;
           }
           
           // Otherwise use a generic name
           return 'Employee';
       }
       
       function getCompletionBreakdown(completions) {
           const breakdown = {};
           completions.forEach(comp => {
               breakdown[comp.pmType] = (breakdown[comp.pmType] || 0) + 1;
           });
           return breakdown;
       }

       // Update the existing exportData function to be more specific
       function exportEquipmentData() {
           const dataToExport = {
               equipment: equipmentData,
               schedule: weeklySchedule,
               yearlySchedules: yearlySchedules,
               exportType: 'equipment_database',
               exportDate: new Date().toISOString()
           };
           
           const dataStr = JSON.stringify(dataToExport, null, 2);
           const dataBlob = new Blob([dataStr], {type: 'application/json'});
           const url = URL.createObjectURL(dataBlob);
           
           const link = document.createElement('a');
           link.href = url;
           link.download = `equipment_database_${new Date().toISOString().split('T')[0]}.json`;
           link.click();
           
           URL.revokeObjectURL(url);
           showAlert('Success', 'Equipment database exported successfully');
       }

       // Utility functions
       function getWeekNumber(date) {
           const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
           const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
           return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
       }

       function showAlert(title, message) {
           document.getElementById('alertTitle').textContent = title;
           document.getElementById('alertMessage').textContent = message;
           document.getElementById('alertModal').style.display = 'block';
       }

       function closeModal() {
           document.getElementById('alertModal').style.display = 'none';
       }

       // Close modal when clicking outside
       window.onclick = function(event) {
           const modal = document.getElementById('alertModal');
           if (event.target === modal) {
               modal.style.display = 'none';
           }
       }

       // Hide equipment suggestions when clicking outside
       document.addEventListener('click', function(event) {
           const suggestions = document.getElementById('equipmentSuggestions');
           const searchInput = document.getElementById('equipmentSearch');
           
           if (!suggestions.contains(event.target) && event.target !== searchInput) {
               suggestions.style.display = 'none';
           }
       });

       // Load recent additions on page load
       window.addEventListener('load', function() {
           loadRecentAdditions();
       });

       // Auto-save functionality
       setInterval(function() {
           saveDataToStorage();
       }, 30000); // Save every 30 seconds

   </script>
</body>
</html>
